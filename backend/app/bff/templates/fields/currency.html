{% block as_form %}
    <div class="row">
        <p style="border-top-width: 10px; margin-top: 10px;margin-bottom: 0px;" class="text-muted text-uppercase text-start">{{ field.title|capitalize}}:</p>
    </div>
    <div class="row">
    <select class="form-control is-valid"
            id="{{ field.prefix ~ field.field_name }}"
            name="{{ field.prefix ~ field.field_name }}"
            data-choices
    >

                {% if field.val %}
                    <option value="{{ field.val.id }}" selected> {{ field.val.name }}</option>
                {% endif %}
    </select>
    </div>
    <script>
        (async function () {
            let element = document.getElementById("{{field.prefix}}{{ field.field_name }}");
            let choices = new Choices(element, {
                removeItemButton: true
            });
            function check_valid() {
                if (element.required) {
                    choices.containerInner.element.classList.add('is-invalid');
                    choices.containerInner.element.classList.remove('is-valid');
                } else {
                    choices.containerInner.element.classList.remove('is-invalid');
                    choices.containerInner.element.classList.add('is-valid');
                }
            }
            function init(){
                choices.setChoices(async () => {
                    try {
                        const items = await fetch('/bff/search?module={{ field.module }}&model={{ field.model }}&query=');
                        const results = await items.json();
                        if (0 === results.length) { // Handle error from result, for example.
                            throw 'Empty!';
                        }
                        return results;
                    } catch (err) {
                        console.error(err);
                    }
                }).then(() => {
                    choices.input.element.focus()
                });
            }
            init()
            if (!element.id.includes('__')){
                check_valid()
            }
        })();
    </script>
{% endblock %}
{% block as_view %}
<div>
        <p class="text-muted mb-2 text-uppercase fw-semibold">{{ field.title }}</p>
        <h5 class="fs-3 mb-0">{{ field.val.english_name or field.val.name or field.val}}</h5>
</div>
{% endblock %}
{% block as_table %}
<td class="{{ field.field_name }}"><a href="#" hx-params="none" hx-get="/base/table/row?module={{ field.module }}&model={{ field.model }}">{{ field.val.code or field.val.english_name}}</a></td>
{% endblock %}